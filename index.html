<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>아랍어 타자 연습</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f5f5f5;
      color: #111;
      display: flex;
      justify-content: center;
      padding: 20px;
    }

    .container {
      width: 100%;
      max-width: 900px;
      background: #fff;
      border-radius: 12px;
      padding: 20px 18px 28px;
      box-shadow: 0 8px 18px rgba(0,0,0,0.06);
    }

    .section-title {
      font-size: 1.4rem;
      font-weight: 700;
      margin-bottom: 10px;
    }

    .sub-title {
      font-size: 0.95rem;
      color: #666;
      margin-bottom: 16px;
    }

    /* ==== 연습 영역 ==== */

    .practice-section {
      margin-bottom: 28px;
      border-bottom: 1px solid #eee;
      padding-bottom: 20px;
    }

    .meaning {
      font-size: 0.95rem;
      color: #555;
      margin-bottom: 18px;
    }

    .arabic-block {
      margin-bottom: 12px;
    }

    .typed-display {
      min-height: 32px;
      font-size: 1.6rem;
      line-height: 1.8;
      direction: rtl;
      text-align: right;
      margin-bottom: 4px;
      word-wrap: break-word;
    }

    .target-display {
      font-size: 1.6rem;
      line-height: 1.8;
      direction: rtl;
      text-align: right;
      color: #b0b0b0;
      word-wrap: break-word;
    }

    .input-area {
      margin-top: 16px;
    }

    .input-label {
      font-size: 0.85rem;
      color: #666;
      margin-bottom: 6px;
    }

    .typing-input {
      width: 100%;
      padding: 10px 12px;
      font-size: 1.2rem;
      direction: rtl;
      text-align: right;
      border-radius: 8px;
      border: 1px solid #ccc;
      outline: none;
    }

    .typing-input:focus {
      border-color: #2196f3;
      box-shadow: 0 0 0 2px rgba(33,150,243,0.1);
    }

    .controls {
      margin-top: 16px;
      display: flex;
      justify-content: space-between;
      gap: 8px;
      flex-wrap: wrap;
      font-size: 0.85rem;
      color: #666;
    }

    .stats {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .btn {
      padding: 6px 12px;
      border-radius: 999px;
      border: none;
      background: #2196f3;
      color: #fff;
      cursor: pointer;
      font-size: 0.9rem;
    }

    .btn:active {
      transform: translateY(1px);
    }

    .correct-char {
      color: #111;
    }

    .wrong-char {
      color: #e53935;
    }

    /* ==== 게임 영역 ==== */

    .game-section {
      margin-top: 8px;
    }

    .game-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }

    .game-tab-btn {
      padding: 6px 10px;
      font-size: 0.9rem;
      border-radius: 999px;
      border: 1px solid #ccc;
      background: #fafafa;
      cursor: pointer;
    }

    .game-tab-btn.active {
      background: #2196f3;
      border-color: #2196f3;
      color: #fff;
    }

    .game-area {
      border-radius: 10px;
      border: 1px solid #eee;
      padding: 14px 12px 16px;
      margin-bottom: 16px;
    }

    .game-meaning {
      font-size: 0.9rem;
      color: #555;
      margin-bottom: 10px;
    }

    .game-display-wrapper {
      position: relative;
      height: 140px;
      overflow: hidden;
      border-radius: 8px;
      background: #fafafa;
      margin-bottom: 10px;
      padding: 6px;
    }

    /* 떨어지는 글자 표시 위치 */
    .fall-word {
      position: absolute;
      right: 12px;
      font-size: 1.7rem;
      direction: rtl;
      text-align: right;
      transform: translateY(0%);
      transition: transform 0.08s linear;
    }

    .game-typed-display {
      min-height: 30px;
      font-size: 1.5rem;
      direction: rtl;
      text-align: right;
      margin-bottom: 4px;
      word-wrap: break-word;
    }

    .game-target-display {
      font-size: 1.5rem;
      direction: rtl;
      text-align: right;
      color: #b0b0b0;
      word-wrap: break-word;
    }

    .game-input {
      width: 100%;
      padding: 8px 10px;
      font-size: 1.1rem;
      direction: rtl;
      text-align: right;
      border-radius: 8px;
      border: 1px solid #ccc;
      outline: none;
    }

    .game-input:focus {
      border-color: #ff9800;
      box-shadow: 0 0 0 2px rgba(255,152,0,0.15);
    }

    .game-stats-row {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      margin-top: 10px;
      font-size: 0.85rem;
      color: #666;
      flex-wrap: wrap;
    }

    .hidden {
      display: none;
    }

    @media (max-width: 600px) {
      body {
        padding: 12px;
      }
      .container {
        padding: 16px 14px 22px;
      }
      .section-title {
        font-size: 1.2rem;
      }
      .typed-display,
      .target-display,
      .game-typed-display,
      .game-target-display,
      .fall-word {
        font-size: 1.4rem;
      }
      .typing-input,
      .game-input {
        font-size: 1.05rem;
      }
      .game-display-wrapper {
        height: 120px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- ===== 연습 섹션 ===== -->
    <section class="practice-section">
      <div class="section-title">단어 / 문장 연습</div>
      <div class="sub-title">한국어 뜻을 보고 아랍어를 그대로 타이핑해 보세요.</div>

      <div class="meaning" id="meaningPractice">제 이름은 지훈입니다.</div>

      <div class="arabic-block">
        <!-- 사용자가 친 글자를 색깔로 보여주는 줄 -->
        <div class="typed-display" id="typedDisplayPractice"></div>
        <!-- 연한 회색 정답 -->
        <div class="target-display" id="targetDisplayPractice"></div>
      </div>

      <div class="input-area">
        <div class="input-label">아랍어로 그대로 타이핑</div>
        <input
          id="typingInputPractice"
          class="typing-input"
          type="text"
          dir="rtl"
          autocomplete="off"
        />
      </div>

      <div class="controls">
        <div class="stats">
          <span id="accuracyPractice">정확도: 100%</span>
          <span id="lengthPractice">0 / 0 글자</span>
        </div>
        <button class="btn" id="nextPracticeBtn">다음 연습</button>
      </div>
    </section>

    <!-- ===== 게임 섹션 ===== -->
    <section class="game-section">
      <div class="section-title">게임 모드</div>
      <div class="sub-title">떨어지는 글자를 막거나, 제한 시간 안에 최대한 많이 타이핑해 보세요.</div>

      <div class="game-tabs">
        <button class="game-tab-btn active" data-game="fall">떨어지는 글자</button>
        <button class="game-tab-btn" data-game="time">타임어택</button>
      </div>

      <!-- 떨어지는 글자 게임 -->
      <div class="game-area" id="fallGameArea">
        <div class="game-meaning" id="fallMeaning">단어의 뜻이 여기에 표시됩니다.</div>

        <div class="game-display-wrapper">
          <div class="fall-word" id="fallWord"></div>
        </div>

        <div class="game-typed-display" id="fallTypedDisplay"></div>
        <div class="game-target-display" id="fallTargetDisplay"></div>

        <div class="input-area" style="margin-top: 10px;">
          <div class="input-label">단어가 바닥에 닿기 전에 정확히 타이핑하세요.</div>
          <input
            id="fallInput"
            class="game-input"
            type="text"
            dir="rtl"
            autocomplete="off"
          />
        </div>

        <div class="game-stats-row">
          <div>
            <span id="fallScore">점수: 0</span> ·
            <span id="fallSpeedInfo">속도: 1.0x</span>
          </div>
          <div>
            <span id="fallStatus">준비 완료</span>
            <button class="btn" id="fallStartBtn" style="margin-left: 8px;">게임 시작</button>
          </div>
        </div>
      </div>

      <!-- 타임어택 게임 -->
      <div class="game-area hidden" id="timeGameArea">
        <div class="game-meaning" id="timeMeaning">한국어 뜻이 여기에 표시됩니다.</div>

        <div class="game-typed-display" id="timeTypedDisplay"></div>
        <div class="game-target-display" id="timeTargetDisplay"></div>

        <div class="input-area" style="margin-top: 10px;">
          <div class="input-label">제한 시간 안에 최대한 많이 타이핑하세요.</div>
          <input
            id="timeInput"
            class="game-input"
            type="text"
            dir="rtl"
            autocomplete="off"
          />
        </div>

        <div class="game-stats-row">
          <div>
            <span id="timeLeft">남은 시간: 30초</span> ·
            <span id="timeScore">완료한 문제: 0개</span>
          </div>
          <div>
            <span id="timeAccuracy">정확도: 100%</span>
            <button class="btn" id="timeStartBtn" style="margin-left: 8px;">시작</button>
          </div>
        </div>
      </div>
    </section>
  </div>

  <script>
    // ===== 연습/게임 공통 데이터 =====
    const exercises = [
      {
        type: "word",
        meaning: "책상",
        text: "مَكْتَبٌ"
      },
      {
        type: "word",
        meaning: "학교",
        text: "مَدْرَسَةٌ"
      },
      {
        type: "sentence-short",
        meaning: "제 이름은 지훈입니다.",
        text: "اِسْمِي جِهُون."
      },
      {
        type: "sentence-short",
        meaning: "만나서 반갑습니다.",
        text: "تَشَرَّفْتُ بِمَعْرِفَتِكَ."
      },
      {
        type: "sentence-long",
        meaning: "나는 아랍어를 조금만 말할 수 있습니다.",
        text: "أَسْتَطِيعُ أَنْ أَتَحَدَّثَ الْعَرَبِيَّةَ قَلِيلًا فَقَطْ."
      },
      {
        type: "sentence-long",
        meaning: "오늘은 대학에서 아랍어 수업을 듣고 친구들과 도서관에 갔습니다.",
        text: "الْيَوْمَ حَضَرْتُ دَرْسًا فِي الْعَرَبِيَّةِ فِي الْجَامِعَةِ، ثُمَّ ذَهَبْتُ مَعَ أَصْدِقَائِي إِلَى الْمَكْتَبَةِ."
      }
    ];

    // ===== 공통: 색칠 함수 =====
    function colorizeText(target, typed) {
      const maxLen = Math.max(target.length, typed.length);
      let html = "";
      let correctCount = 0;

      for (let i = 0; i < maxLen; i++) {
        const targetChar = target[i] || "";
        const typedChar = typed[i] || "";

        if (!typedChar) continue;

        if (typedChar === targetChar) {
          html += `<span class="correct-char">${typedChar}</span>`;
          correctCount++;
        } else {
          html += `<span class="wrong-char">${typedChar}</span>`;
        }
      }

      return { html, correctCount };
    }

    // ===== 1. 연습 모드 =====
    const meaningPractice = document.getElementById("meaningPractice");
    const targetDisplayPractice = document.getElementById("targetDisplayPractice");
    const typedDisplayPractice = document.getElementById("typedDisplayPractice");
    const typingInputPractice = document.getElementById("typingInputPractice");
    const accuracyPractice = document.getElementById("accuracyPractice");
    const lengthPractice = document.getElementById("lengthPractice");
    const nextPracticeBtn = document.getElementById("nextPracticeBtn");

    let practiceIndex = 0;
    let practiceCurrent = exercises[practiceIndex];

    function loadPractice(index) {
      practiceCurrent = exercises[index];
      meaningPractice.textContent = practiceCurrent.meaning;
      targetDisplayPractice.textContent = practiceCurrent.text;
      typedDisplayPractice.innerHTML = "";
      typingInputPractice.value = "";
      lengthPractice.textContent = `0 / ${practiceCurrent.text.length} 글자`;
      accuracyPractice.textContent = "정확도: 100%";
      typingInputPractice.focus();
    }

    function updatePracticeTyping() {
      const typed = typingInputPractice.value;
      const target = practiceCurrent.text;
      const { html, correctCount } = colorizeText(target, typed);
      typedDisplayPractice.innerHTML = html;

      const totalTyped = typed.length;
      const accuracy = totalTyped === 0 ? 100 : Math.round((correctCount / totalTyped) * 100);

      accuracyPractice.textContent = `정확도: ${accuracy}%`;
      lengthPractice.textContent = `${typed.length} / ${target.length} 글자`;
    }

    typingInputPractice.addEventListener("input", updatePracticeTyping);

    nextPracticeBtn.addEventListener("click", () => {
      practiceIndex = (practiceIndex + 1) % exercises.length;
      loadPractice(practiceIndex);
    });

    // 초기 로드
    loadPractice(practiceIndex);

    // ===== 2. 게임 탭 전환 =====
    const tabButtons = document.querySelectorAll(".game-tab-btn");
    const fallGameArea = document.getElementById("fallGameArea");
    const timeGameArea = document.getElementById("timeGameArea");

    tabButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        tabButtons.forEach(b => b.classList.remove("active"));
        btn.classList.add("active");

        const gameType = btn.dataset.game;
        if (gameType === "fall") {
          fallGameArea.classList.remove("hidden");
          timeGameArea.classList.add("hidden");
        } else {
          timeGameArea.classList.remove("hidden");
          fallGameArea.classList.add("hidden");
        }
      });
    });

    // ===== 3. 떨어지는 글자 게임 =====
    const fallMeaning = document.getElementById("fallMeaning");
    const fallWordEl = document.getElementById("fallWord");
    const fallTypedDisplay = document.getElementById("fallTypedDisplay");
    const fallTargetDisplay = document.getElementById("fallTargetDisplay");
    const fallInput = document.getElementById("fallInput");
    const fallScoreEl = document.getElementById("fallScore");
    const fallSpeedInfo = document.getElementById("fallSpeedInfo");
    const fallStatus = document.getElementById("fallStatus");
    const fallStartBtn = document.getElementById("fallStartBtn");

    let fallState = {
      active: false,
      score: 0,
      y: 0,
      speed: 0.5, // 퍼센트 단위 이동 속도
      timerId: null,
      current: null
    };

    function getRandomWord() {
      const wordList = exercises.filter(ex => ex.type === "word" || ex.type === "sentence-short");
      if (wordList.length === 0) return null;
      const idx = Math.floor(Math.random() * wordList.length);
      return wordList[idx];
    }

    function startFallRound() {
      fallState.current = getRandomWord();
      if (!fallState.current) return;

      fallState.y = 0;
      fallWordEl.style.transform = "translateY(0%)";
      fallWordEl.textContent = fallState.current.text;
      fallMeaning.textContent = fallState.current.meaning;
      fallTargetDisplay.textContent = fallState.current.text;
      fallTypedDisplay.innerHTML = "";
      fallInput.value = "";
      fallInput.focus();
    }

    function updateFallingPosition() {
      if (!fallState.active) return;
      fallState.y += fallState.speed;

      if (fallState.y >= 100) {
        // 바닥에 닿음 → 게임 오버
        fallWordEl.style.transform = "translateY(100%)";
        stopFallGame(false);
      } else {
        fallWordEl.style.transform = `translateY(${fallState.y}%)`;
      }
    }

    function startFallGame() {
      if (fallState.active) return;

      fallState.active = true;
      fallState.score = 0;
      fallState.speed = 0.8; // 시작 속도
      fallScoreEl.textContent = `점수: ${fallState.score}`;
      fallSpeedInfo.textContent = `속도: ${fallState.speed.toFixed(1)}x`;
      fallStatus.textContent = "진행 중...";
      startFallRound();

      if (fallState.timerId) clearInterval(fallState.timerId);
      fallState.timerId = setInterval(updateFallingPosition, 80);
    }

    function stopFallGame(cleared = false) {
      fallState.active = false;
      if (fallState.timerId) {
        clearInterval(fallState.timerId);
        fallState.timerId = null;
      }
      if (cleared) {
        fallStatus.textContent = "성공! 다음 단어로...";
      } else {
        fallStatus.textContent = `게임 오버 · 최종 점수: ${fallState.score}`;
      }
    }

    function handleFallInput() {
      if (!fallState.active || !fallState.current) return;
      const typed = fallInput.value;
      const target = fallState.current.text;

      const { html } = colorizeText(target, typed);
      fallTypedDisplay.innerHTML = html;

      // 전체가 맞으면 성공
      if (typed === target) {
        fallState.score++;
        fallScoreEl.textContent = `점수: ${fallState.score}`;
        fallState.speed += 0.1; // 속도 조금씩 증가
        fallSpeedInfo.textContent = `속도: ${fallState.speed.toFixed(1)}x`;
        stopFallGame(true);

        // 잠깐 멈춘 뒤 다음 라운드 시작
        setTimeout(() => {
          fallStatus.textContent = "진행 중...";
          fallState.active = true;
          startFallRound();
        }, 700);
      }
    }

    fallStartBtn.addEventListener("click", () => {
      startFallGame();
    });

    fallInput.addEventListener("input", handleFallInput);

    // ===== 4. 타임어택 게임 =====
    const timeMeaning = document.getElementById("timeMeaning");
    const timeTypedDisplay = document.getElementById("timeTypedDisplay");
    const timeTargetDisplay = document.getElementById("timeTargetDisplay");
    const timeInput = document.getElementById("timeInput");
    const timeLeftEl = document.getElementById("timeLeft");
    const timeScoreEl = document.getElementById("timeScore");
    const timeAccuracyEl = document.getElementById("timeAccuracy");
    const timeStartBtn = document.getElementById("timeStartBtn");

    let timeState = {
      active: false,
      timeLeft: 30,
      timerId: null,
      score: 0,
      correctChars: 0,
      typedChars: 0,
      current: null
    };

    function getRandomSentence() {
      const list = exercises.filter(ex => ex.type === "sentence-short" || ex.type === "sentence-long");
      if (list.length === 0) return null;
      const idx = Math.floor(Math.random() * list.length);
      return list[idx];
    }

    function loadTimeQuestion() {
      timeState.current = getRandomSentence();
      if (!timeState.current) return;

      timeMeaning.textContent = timeState.current.meaning;
      timeTargetDisplay.textContent = timeState.current.text;
      timeTypedDisplay.innerHTML = "";
      timeInput.value = "";
      timeInput.focus();
    }

    function updateTimeTyping() {
      if (!timeState.active || !timeState.current) return;

      const typed = timeInput.value;
      const target = timeState.current.text;
      const { html, correctCount } = colorizeText(target, typed);
      timeTypedDisplay.innerHTML = html;

      timeState.correctChars += 0; // 여기서 누적은 하지 않고, 마지막에 다시 계산해도 됨
      timeState.typedChars += 0;   // (간단하게: 정확도는 마지막에 전부 다시 계산해도 됨)

      // 문제를 정확히 다 쳤으면 다음 문제
      if (typed === target) {
        timeState.score++;
        timeScoreEl.textContent = `완료한 문제: ${timeState.score}개`;
        // 다음 문장 로드
        loadTimeQuestion();
      }

      // 현재 문제 기준 정확도 보여주기
      const totalTyped = typed.length;
      const acc = totalTyped === 0 ? 100 : Math.round((correctCount / totalTyped) * 100);
      timeAccuracyEl.textContent = `정확도: ${acc}%`;
    }

    function startTimeAttack() {
      if (timeState.active) return;

      timeState.active = true;
      timeState.timeLeft = 30; // 기본 30초
      timeState.score = 0;
      timeScoreEl.textContent = "완료한 문제: 0개";
      timeLeftEl.textContent = `남은 시간: ${timeState.timeLeft}초`;
      timeAccuracyEl.textContent = "정확도: 100%";

      loadTimeQuestion();

      if (timeState.timerId) clearInterval(timeState.timerId);
      timeState.timerId = setInterval(() => {
        timeState.timeLeft--;
        timeLeftEl.textContent = `남은 시간: ${timeState.timeLeft}초`;

        if (timeState.timeLeft <= 0) {
          endTimeAttack();
        }
      }, 1000);
    }

    function endTimeAttack() {
      timeState.active = false;
      if (timeState.timerId) {
        clearInterval(timeState.timerId);
        timeState.timerId = null;
      }
      timeLeftEl.textContent = `시간 종료 · 최종 점수: ${timeState.score}개`;
      // 입력 막지는 않지만, 다시 시작 누르면 새 라운드 시작
    }

    timeStartBtn.addEventListener("click", () => {
      startTimeAttack();
    });

    timeInput.addEventListener("input", updateTimeTyping);
  </script>
</body>
</html>
