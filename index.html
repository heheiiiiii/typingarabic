<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>아랍어 타자 연습</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f3f3f3;
      color: #111;
      display: flex;
      justify-content: center;
      align-items: stretch;
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      width: 100%;
      max-width: 1100px;
      background: #fff;
      border-radius: 16px;
      padding: 20px 24px 28px;
      box-shadow: 0 10px 26px rgba(0,0,0,0.08);
      display: flex;
      flex-direction: column;
      min-height: 90vh;
    }

    .app-title {
      text-align: center;
      font-size: 1.6rem;
      font-weight: 700;
      margin-bottom: 14px;
    }

    .main-tabs {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin-bottom: 18px;
      flex-wrap: nowrap;
      white-space: nowrap;
    }

    .main-tab-btn {
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid #ccc;
      background: #fafafa;
      font-size: 0.85rem;
      cursor: pointer;
    }

    .main-tab-btn.active {
      background: #2196f3;
      border-color: #2196f3;
      color: #fff;
    }

    .tab-section { flex: 1; display: none; }
    .tab-section.active {
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      min-height: 0;
    }

    .mode-title {
      text-align: center;
      font-size: 1.25rem;
      font-weight: 600;
      margin-bottom: 10px;
    }

    .top-stats {
      text-align: right;
      font-size: 0.9rem;
      color: #666;
      margin-bottom: 4px;
    }

    .center-wrap {
      max-width: 780px;
      margin: 0 auto;
      text-align: center;
      display: flex;
      flex-direction: column;
      gap: 14px;
      flex: 1;
    }

    .info-text {
      font-size: 0.9rem;
      color: #666;
      margin-bottom: 4px;
    }

    .box {
      background: #f1f1f1;
      border-radius: 10px;
      padding: 12px 14px;
      text-align: center;
    }

    .combined-box { display: flex; flex-direction: column; gap: 6px; }

    .meaning-line { font-size: 1rem; color: #333; }

    .arabic-line {
      font-size: 1.6rem;
      direction: rtl;
      text-align: center;
      color: #111;
      word-wrap: break-word;
      line-height: 1.8;
      white-space: pre-line;
    }

    .typed-display {
      min-height: 34px;
      font-size: 1.6rem;
      direction: rtl;
      text-align: center;
      word-wrap: break-word;
      line-height: 1.8;
    }

    .input-area { margin-top: 6px; }

    .typing-input {
      width: 100%;
      max-width: 640px;
      padding: 10px 12px;
      font-size: 1.2rem;
      direction: rtl;
      text-align: center;
      border-radius: 10px;
      border: 1px solid #ccc;
      outline: none;
    }

    .typing-input:focus {
      border-color: #2196f3;
      box-shadow: 0 0 0 2px rgba(33,150,243,0.12);
    }

    .bottom-row {
      margin-top: 14px;
      display: flex;
      justify-content: flex-end;
      align-items: center;
      gap: 10px;
      font-size: 0.9rem;
      color: #666;
      flex-wrap: wrap;
    }

    .btn {
      padding: 8px 16px;
      border-radius: 999px;
      border: none;
      background: #2196f3;
      color: #fff;
      cursor: pointer;
      font-size: 0.9rem;
      white-space: nowrap;
    }

    .btn:active { transform: translateY(1px); }

    .correct-char { color: #111; }
    .wrong-char { color: #e53935; }

    .long-selector { display: none; text-align: left; }
    .long-selector.active { display: block; }

    .long-selector-title {
      font-size: 0.9rem;
      color: #444;
      margin-bottom: 4px;
    }

    .long-list {
      border-radius: 10px;
      border: 1px solid #ddd;
      background: #fafafa;
      max-height: 170px;
      overflow-y: auto;
      padding: 4px 0;
    }

    .long-item {
      padding: 6px 10px;
      font-size: 0.9rem;
      cursor: pointer;
    }

    .long-item:hover { background: #e3f2fd; }
    .long-item.selected { background: #bbdefb; font-weight: 600; }

    .game-title {
      text-align: center;
      font-size: 1.25rem;
      font-weight: 600;
      margin-bottom: 10px;
    }

    .game-desc {
      text-align: center;
      font-size: 0.9rem;
      color: #666;
      margin-bottom: 14px;
    }

    .game-inner-tabs {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }

    .game-tab-btn {
      padding: 6px 14px;
      border-radius: 999px;
      border: 1px solid #ccc;
      background: #fafafa;
      font-size: 0.85rem;
      cursor: pointer;
    }

    .game-tab-btn.active {
      background: #ff9800;
      border-color: #ff9800;
      color: #fff;
    }

    .game-content { flex: 1; display: none; flex-direction: column; }
    .game-content.active { display: flex; flex-direction: column; }

    .game-center-wrap {
      max-width: 780px;
      margin: 0 auto;
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 12px;
      text-align: center;
    }

    .game-typed-display {
      min-height: 30px;
      font-size: 1.5rem;
      direction: rtl;
      text-align: center;
      word-wrap: break-word;
      line-height: 1.7;
    }

    .game-input {
      width: 100%;
      max-width: 640px;
      padding: 8px 11px;
      font-size: 1.1rem;
      direction: rtl;
      text-align: center;
      border-radius: 10px;
      border: 1px solid #ccc;
      outline: none;
    }

    .game-input:focus {
      border-color: #ff9800;
      box-shadow: 0 0 0 2px rgba(255,152,0,0.18);
    }

    .game-top-stats {
      display: flex;
      justify-content: space-between;
      font-size: 0.9rem;
      color: #666;
      margin-bottom: 4px;
    }

    .game-stats-row {
      margin-top: 10px;
      display: flex;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
      font-size: 0.9rem;
      color: #666;
      align-items: center;
    }

    .fall-wrapper {
      position: relative;
      height: 320px;
      overflow: hidden;
      border-radius: 12px;
      background: #fafafa;
      margin-top: 6px;
      margin-bottom: 4px;
    }

    .fall-word {
      position: absolute;
      left: 0;
      top: -40px;
      font-size: 1.9rem;
      direction: rtl;
      text-align: center;
      white-space: nowrap;
      transform: translateX(-50%);
    }

    .game-arabic-box {
      background: #f1f1f1;
      border-radius: 10px;
      padding: 10px 14px;
      font-size: 1.5rem;
      direction: rtl;
      text-align: center;
      color: #111;
      word-wrap: break-word;
      line-height: 1.7;
      white-space: pre-line;
    }

    .game-meaning-box {
      background: #f1f1f1;
      border-radius: 10px;
      padding: 10px 14px;
      font-size: 0.95rem;
      color: #333;
    }

    @media (max-width: 768px) {
      body { padding: 10px; }
      .container { padding: 16px 16px 22px; min-height: 100vh; }
      .app-title { font-size: 1.4rem; }
      .arabic-line,
      .typed-display,
      .game-arabic-box,
      .game-typed-display,
      .fall-word { font-size: 1.4rem; }
      .typing-input,
      .game-input { font-size: 1.05rem; }
      .fall-wrapper { height: 260px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="app-title">아랍어 타자 연습</h1>

    <div class="main-tabs">
      <button class="main-tab-btn active" data-tab="word">단어</button>
      <button class="main-tab-btn" data-tab="short">문장</button>
      <button class="main-tab-btn" data-tab="long">긴 글</button>
      <button class="main-tab-btn" data-tab="game">게임 모드</button>
    </div>

    <!-- 연습 섹션 -->
    <section class="tab-section active" id="practiceSection">
      <div class="mode-title" id="modeTitle">단어</div>

      <div class="center-wrap">
        <div class="top-stats">
          <span id="practiceTopStats">진행도: 0개 · 정확도: 100% · 0 / 0 글자</span>
        </div>

        <div class="long-selector" id="longSelector">
          <div class="long-selector-title">긴 글 선택</div>
          <div class="long-list" id="longList"></div>
        </div>

        <div>
          <div class="box combined-box">
            <div class="meaning-line" id="practiceMeaning">제 이름은 지훈입니다.</div>
            <div class="arabic-line" id="practiceTarget">اِسْمِي جِهُون.</div>
          </div>
        </div>

        <div>
          <div class="info-text">타이핑 결과</div>
          <div class="typed-display" id="practiceTypedDisplay"></div>
        </div>

        <div class="input-area">
          <input
            id="practiceInput"
            class="typing-input"
            type="text"
            dir="rtl"
            autocomplete="off"
          />
        </div>

        <div class="bottom-row">
          <button class="btn" id="practiceNextBtn">다음</button>
        </div>
      </div>
    </section>

    <!-- 게임 섹션 -->
    <section class="tab-section" id="gameSection">
      <div class="game-title">게임 모드</div>
      <div class="game-desc">단어 낙하 게임과 문장 타임어택으로 연습해 보세요.</div>

      <div class="game-inner-tabs">
        <button class="game-tab-btn active" data-game="fallWord">단어 게임</button>
        <button class="game-tab-btn" data-game="timeSentence">문장 게임</button>
      </div>

      <!-- 단어 게임 -->
      <div class="game-content active" id="fallWordArea">
        <div class="game-center-wrap">
          <div class="game-top-stats">
            <span id="fallScoreTop">점수: 0</span>
            <span id="fallSpeedInfo">속도: 1.5x</span>
          </div>

          <div class="fall-wrapper" id="fallWrapper"></div>

          <div>
            <div class="info-text">타이핑 결과</div>
            <div class="game-typed-display" id="fallTypedDisplay"></div>
          </div>

          <div class="input-area">
            <input
              id="fallInput"
              class="game-input"
              type="text"
              dir="rtl"
              autocomplete="off"
            />
          </div>

          <div class="game-stats-row">
            <div id="fallStatus">준비 완료</div>
            <div>
              <button class="btn" id="fallStartBtn">게임 시작</button>
            </div>
          </div>
        </div>
      </div>

      <!-- 문장 게임 -->
      <div class="game-content" id="timeSentenceArea">
        <div class="game-center-wrap">
          <div class="game-top-stats">
            <span id="timeLeft">남은 시간: 30초</span>
            <span id="timeScore">완료한 문제: 0개</span>
            <span id="timeAccuracy">정확도: 100%</span>
          </div>

          <div>
            <div class="game-meaning-box" id="timeMeaning">한국어 뜻이 여기에 표시됩니다.</div>
          </div>

          <div>
            <div class="info-text">아랍어</div>
            <div class="game-arabic-box" id="timeTargetDisplay"></div>
          </div>

          <div>
            <div class="info-text">타이핑 결과</div>
            <div class="game-typed-display" id="timeTypedDisplay"></div>
          </div>

          <div class="input-area">
            <input
              id="timeInput"
              class="game-input"
              type="text"
              dir="rtl"
              autocomplete="off"
            />
          </div>

          <div class="game-stats-row">
            <div></div>
            <div>
              <button class="btn" id="timeStartBtn">시작</button>
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>

 <script>
  // ---------- 공통 유틸 ----------
  function stripDiacritics(str) {
    // 아랍어 모음부호(타쉬킬) 제거
    return str.replace(/[\u0610-\u061A\u064B-\u0652\u0670\u06D6-\u06ED]/g, "");
  }

  function shuffleArray(arr) {
    const a = arr.slice();
    for (let i = a.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
  }

  function colorizeText(target, typed) {
    const baseTarget = stripDiacritics(target);   // 자음 기준 목표
    let html = "";
    let correctCount = 0;

    for (let i = 0; i < typed.length; i++) {
      const ch = typed[i];
      const tgt = baseTarget[i] || "";
      if (ch === tgt) {
        html += '<span class="correct-char">' + ch + '</span>';
        correctCount++;
      } else {
        html += '<span class="wrong-char">' + ch + '</span>';
      }
    }

    const baseLen = baseTarget.length;
    return { html, correctCount, baseLen };
  }

  // ---------- 문제 데이터 ----------
  const exercises = [
    // 단어
    { type: "word", meaning: "책상", text: "مَكْتَبٌ" },
    { type: "word", meaning: "학교", text: "مَدْرَسَةٌ" },
    { type: "word", meaning: "친구", text: "صَدِيقٌ" },

    // 짧은 문장
    { type: "sentence-short", meaning: "제 이름은 지훈입니다.", text: "اِسْمِي جِهُون." },
    { type: "sentence-short", meaning: "만나서 반갑습니다.", text: "تَشَرَّفْتُ بِمَعْرِفَتِكَ." },

    // 긴 글 예시 1
    {
      type: "sentence-long",
      title: "동화 1",
      meaning: "여름날 학교에 가는 소년의 이야기",
      text:
"فِي يَوْمٍ مِنَ الأَيَّامِ ذَهَبَ وَلَدٌ صَغِيرٌ إِلَى الْمَدْرَسَةِ.\n" +
"كَانَ يَحْمِلُ فِي حَقِيبَتِهِ كِتَابَ الْقِصَصِ الَّذِي يُحِبُّهُ جِدًّا.\n" +
"فِي طَرِيقِهِ قَابَلَ صَدِيقَهُ فِي الْحَيِّ، وَتَحَدَّثَا عَنِ الْأَحْلَامِ وَالْمُسْتَقْبَلِ."
    },
    // 긴 글 예시 2
    {
      type: "sentence-long",
      title: "뉴스 1",
      meaning: "아랍어 교육 프로그램 개설에 관한 뉴스",
      text:
"أَعْلَنَتِ الْجَامِعَةُ الْيَوْمَ عَنْ بَرْنَامَجٍ جَدِيدٍ لِتَعْلِيمِ اللُّغَةِ الْعَرَبِيَّةِ.\n" +
"يَهْدِفُ الْبَرْنَامَجُ إِلَى مُسَاعَدَةِ الطُّلَّابِ عَلَى التَّحَدُّثِ وَالْكِتَابَةِ بِطَلَاقَةٍ.\n" +
"سَيَبْدَأُ التَّسْجِيلُ فِي الشَّهْرِ الْمُقْبِلِ وَسَيَكُونُ مَجَّانِيًّا لِجَمِيعِ الطُّلَّابِ."
    }
  ];

  // ---------- 상단 탭 ----------
  const mainTabButtons = document.querySelectorAll(".main-tab-btn");
  const practiceSection = document.getElementById("practiceSection");
  const gameSection = document.getElementById("gameSection");
  let currentMode = "word";

  mainTabButtons.forEach(btn => {
    btn.addEventListener("click", () => {
      mainTabButtons.forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      const tab = btn.dataset.tab;

      if (tab === "game") {
        practiceSection.classList.remove("active");
        gameSection.classList.add("active");
      } else {
        gameSection.classList.remove("active");
        practiceSection.classList.add("active");
        currentMode = tab;
        setupPracticeMode();
      }
    });
  });

  // ---------- 연습 모드 ----------
  const modeTitle = document.getElementById("modeTitle");
  const practiceMeaning = document.getElementById("practiceMeaning");
  const practiceTarget = document.getElementById("practiceTarget");
  const practiceTypedDisplay = document.getElementById("practiceTypedDisplay");
  const practiceInput = document.getElementById("practiceInput");
  const practiceTopStats = document.getElementById("practiceTopStats");
  const longSelector = document.getElementById("longSelector");
  const longListEl = document.getElementById("longList");
  const practiceNextBtn = document.getElementById("practiceNextBtn");

  let practiceList = [];
  let practiceIndex = 0;
  let practiceCurrent = null;

  function updatePracticeTopStats(accuracy, typedLen, totalLen) {
    const progressCount = (practiceList && practiceList.length > 0)
      ? (practiceIndex + 1)
      : 0;
    practiceTopStats.textContent =
      "진행도: " + progressCount + "개 · 정확도: " +
      accuracy + "% · " + typedLen + " / " + totalLen + " 글자";
  }

  function buildLongList() {
    longListEl.innerHTML = "";
    practiceList.forEach((item, idx) => {
      const div = document.createElement("div");
      div.className = "long-item" + (idx === practiceIndex ? " selected" : "");
      const title = item.title || item.meaning || ("긴 글 " + (idx + 1));
      div.textContent = title;
      div.addEventListener("click", () => {
        practiceIndex = idx;
        loadPracticeItem();
        document.querySelectorAll(".long-item").forEach((el, i) => {
          el.classList.toggle("selected", i === practiceIndex);
        });
      });
      longListEl.appendChild(div);
    });
  }

  function setupPracticeMode() {
    if (currentMode === "word") {
      modeTitle.textContent = "단어";
      practiceList = shuffleArray(exercises.filter(ex => ex.type === "word"));
      longSelector.classList.remove("active");
    } else if (currentMode === "short") {
      modeTitle.textContent = "문장";
      practiceList = shuffleArray(exercises.filter(ex => ex.type === "sentence-short"));
      longSelector.classList.remove("active");
    } else {
      modeTitle.textContent = "긴 글";
      practiceList = exercises.filter(ex => ex.type === "sentence-long"); // 긴 글은 순서 유지
      longSelector.classList.add("active");
      buildLongList();
    }

    if (practiceList.length === 0) {
      practiceMeaning.textContent = "연습할 문장이 없습니다.";
      practiceTarget.textContent = "";
      practiceTypedDisplay.innerHTML = "";
      practiceInput.value = "";
      updatePracticeTopStats(100, 0, 0);
      return;
    }

    practiceIndex = 0;
    loadPracticeItem();
  }

  function loadPracticeItem() {
    practiceCurrent = practiceList[practiceIndex];
    const targetText = practiceCurrent.text || "";

    practiceMeaning.textContent = practiceCurrent.meaning || "";
    practiceTarget.textContent = targetText;
    practiceTypedDisplay.innerHTML = "";
    practiceInput.value = "";

    const baseLen = stripDiacritics(targetText).length;
    updatePracticeTopStats(100, 0, baseLen);

    if (currentMode === "long") {
      document.querySelectorAll(".long-item").forEach((el, i) => {
        el.classList.toggle("selected", i === practiceIndex);
      });
    }

    practiceInput.focus();
  }

  function updatePracticeTyping() {
    if (!practiceCurrent) return;
    const typed = practiceInput.value;
    const target = practiceCurrent.text || "";

    const result = colorizeText(target, typed);
    const html = result.html;
    const correctCount = result.correctCount;
    const baseLen = result.baseLen;

    practiceTypedDisplay.innerHTML = html;

    const totalTyped = typed.length;
    const accuracy = totalTyped === 0
      ? 100
      : Math.round((correctCount / totalTyped) * 100);

    updatePracticeTopStats(accuracy, totalTyped, baseLen);
  }

  function goToNextPractice() {
    if (practiceList.length === 0) return;
    practiceIndex = (practiceIndex + 1) % practiceList.length;
    loadPracticeItem();
  }

  practiceInput.addEventListener("input", updatePracticeTyping);
  // 엔터로도 다음 문제
  practiceInput.addEventListener("keydown", function (e) {
    if (e.key === "Enter") {
      e.preventDefault();
      goToNextPractice();
    }
  });
  // 다음 버튼으로도 이동
  practiceNextBtn.addEventListener("click", goToNextPractice);

  // 최초 로딩 시 단어 모드
  setupPracticeMode();

  // ---------- 게임 탭 전환 ----------
  const gameTabButtons = document.querySelectorAll(".game-tab-btn");
  const fallWordArea = document.getElementById("fallWordArea");
  const timeSentenceArea = document.getElementById("timeSentenceArea");

  gameTabButtons.forEach(btn => {
    const handler = function (e) {
      e.preventDefault();
      gameTabButtons.forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      const gameType = btn.dataset.game;

      if (gameType === "fallWord") {
        fallWordArea.classList.add("active");
        timeSentenceArea.classList.remove("active");
      } else {
        timeSentenceArea.classList.add("active");
        fallWordArea.classList.remove("active");
      }
    };

    // 클릭 + 터치 모두 대응
    btn.addEventListener("click", handler);
    btn.addEventListener("touchstart", function (e) {
      e.preventDefault();
      handler(e);
    }, { passive: false });
  });

  // ---------- 단어 게임 (위 -> 아래) ----------
  const fallWrapper = document.getElementById("fallWrapper");
  const fallTypedDisplay = document.getElementById("fallTypedDisplay");
  const fallInput = document.getElementById("fallInput");
  const fallScoreTop = document.getElementById("fallScoreTop");
  const fallSpeedInfo = document.getElementById("fallSpeedInfo");
  const fallStatus = document.getElementById("fallStatus");
  const fallStartBtn = document.getElementById("fallStartBtn");

  let fallState = {
    active: false,
    score: 0,
    speed: 1.5,
    timerId: null,
    spawnId: null,
    items: [],
    lanes: [10, 30, 50, 70, 90],
    nextLaneIndex: 0,
    current: null
  };

  function getRandomWord() {
    const wordList = exercises.filter(ex => ex.type === "word");
    if (wordList.length === 0) return null;
    const idx = Math.floor(Math.random() * wordList.length);
    return wordList[idx];
  }

  function spawnFallWord() {
    if (!fallState.active) return;
    const data = getRandomWord();
    if (!data) return;

    const id = Date.now() + Math.random();
    const lane = fallState.lanes[fallState.nextLaneIndex];
    fallState.nextLaneIndex = (fallState.nextLaneIndex + 1) % fallState.lanes.length;

    const el = document.createElement("div");
    el.className = "fall-word";
    el.dataset.id = id;
    el.textContent = data.text;

    let yPx = -40;
    el.style.top = yPx + "px";
    el.style.left = lane + "%";

    fallWrapper.appendChild(el);

    const item = { id: id, text: data.text, el: el, yPx: yPx, lane: lane };
    fallState.items.push(item);

    if (!fallState.current) {
      fallState.current = item;
      fallInput.value = "";
      fallTypedDisplay.innerHTML = "";
    }
  }

  function updateFallingPosition() {
    if (!fallState.active) return;
    const wrapperHeight = fallWrapper.clientHeight;

    for (let i = 0; i < fallState.items.length; i++) {
      const item = fallState.items[i];
      item.yPx += fallState.speed;
      item.el.style.top = item.yPx + "px";

      const bottom = item.yPx + item.el.offsetHeight;
      if (bottom >= wrapperHeight) {
        stopFallGame(false);
        return;
      }
    }
  }

  function startFallGame() {
    if (fallState.active) return;

    fallState.active = true;
    fallState.score = 0;
    fallState.speed = 1.5;
    fallState.items.forEach(function (i) { i.el.remove(); });
    fallState.items = [];
    fallState.current = null;
    fallWrapper.innerHTML = "";
    fallScoreTop.textContent = "점수: 0";
    fallSpeedInfo.textContent = "속도: 1.5x";
    fallStatus.textContent = "진행 중...";
    fallTypedDisplay.innerHTML = "";
    fallInput.value = "";
    fallInput.focus();

    if (fallState.timerId) clearInterval(fallState.timerId);
    if (fallState.spawnId) clearInterval(fallState.spawnId);

    fallState.timerId = setInterval(updateFallingPosition, 40);
    fallState.spawnId = setInterval(spawnFallWord, 2200);

    spawnFallWord();
  }

  function stopFallGame(cleared) {
    fallState.active = false;
    if (fallState.timerId) {
      clearInterval(fallState.timerId);
      fallState.timerId = null;
    }
    if (fallState.spawnId) {
      clearInterval(fallState.spawnId);
      fallState.spawnId = null;
    }

    if (!cleared) {
      fallStatus.textContent = "게임 오버 · 최종 점수: " + fallState.score;
    } else {
      fallStatus.textContent = "게임 종료 · 점수: " + fallState.score;
    }
  }

  function handleFallInput() {
    if (!fallState.active || !fallState.current) return;

    const typed = fallInput.value;
    const target = fallState.current.text;
    const result = colorizeText(target, typed);
    const html = result.html;

    fallTypedDisplay.innerHTML = html;

    if (stripDiacritics(typed) === stripDiacritics(target)) {
      fallState.score++;
      fallScoreTop.textContent = "점수: " + fallState.score;

      fallState.speed += 0.3;
      fallSpeedInfo.textContent = "속도: " + fallState.speed.toFixed(1) + "x";

      fallState.current.el.remove();
      fallState.items = fallState.items.filter(function (it) {
        return it.id !== fallState.current.id;
      });
      fallState.current = fallState.items[0] || null;

      fallInput.value = "";
      fallTypedDisplay.innerHTML = "";
    }
  }

  // 게임 시작 버튼: 클릭 + 터치 모두 대응
  fallStartBtn.addEventListener("click", function () {
    startFallGame();
  });
  fallStartBtn.addEventListener("touchstart", function (e) {
    e.preventDefault();
    startFallGame();
  }, { passive: false });

  fallInput.addEventListener("input", handleFallInput);

  // ---------- 문장 타임어택 ----------
  const timeMeaning = document.getElementById("timeMeaning");
  const timeTargetDisplay = document.getElementById("timeTargetDisplay");
  const timeTypedDisplay = document.getElementById("timeTypedDisplay");
  const timeInput = document.getElementById("timeInput");
  const timeLeftEl = document.getElementById("timeLeft");
  const timeScoreEl = document.getElementById("timeScore");
  const timeAccuracyEl = document.getElementById("timeAccuracy");
  const timeStartBtn = document.getElementById("timeStartBtn");

  let timeState = {
    active: false,
    timeLeft: 30,
    timerId: null,
    score: 0,
    current: null
  };

  function getRandomSentence() {
    const list = exercises.filter(function (ex) {
      return ex.type === "sentence-short";
    });
    if (list.length === 0) return null;
    const idx = Math.floor(Math.random() * list.length);
    return list[idx];
  }

  function loadTimeQuestion() {
    timeState.current = getRandomSentence();
    if (!timeState.current) return;

    timeMeaning.textContent = timeState.current.meaning || "";
    timeTargetDisplay.textContent = timeState.current.text || "";
    timeTypedDisplay.innerHTML = "";
    timeInput.value = "";
    timeInput.focus();
  }

  function updateTimeTyping() {
    if (!timeState.active || !timeState.current) return;

    const typed = timeInput.value;
    const target = timeState.current.text;
    const result = colorizeText(target, typed);
    const html = result.html;
    const correctCount = result.correctCount;

    timeTypedDisplay.innerHTML = html;

    if (stripDiacritics(typed) === stripDiacritics(target)) {
      timeState.score++;
      timeScoreEl.textContent = "완료한 문제: " + timeState.score + "개";
      loadTimeQuestion();
    }

    const totalTyped = typed.length;
    const acc = totalTyped === 0
      ? 100
      : Math.round((correctCount / totalTyped) * 100);
    timeAccuracyEl.textContent = "정확도: " + acc + "%";
  }

  function startTimeAttack() {
    if (timeState.active) return;

    timeState.active = true;
    timeState.timeLeft = 30;
    timeState.score = 0;
    timeScoreEl.textContent = "완료한 문제: 0개";
    timeLeftEl.textContent = "남은 시간: 30초";
    timeAccuracyEl.textContent = "정확도: 100%";
    loadTimeQuestion();

    if (timeState.timerId) clearInterval(timeState.timerId);
    timeState.timerId = setInterval(function () {
      timeState.timeLeft--;
      if (timeState.timeLeft <= 0) {
        timeLeftEl.textContent = "남은 시간: 0초";
        endTimeAttack();
      } else {
        timeLeftEl.textContent = "남은 시간: " + timeState.timeLeft + "초";
      }
    }, 1000);
  }

  function endTimeAttack() {
    timeState.active = false;
    if (timeState.timerId) {
      clearInterval(timeState.timerId);
      timeState.timerId = null;
    }
    timeLeftEl.textContent = "시간 종료 · 최종 점수: " + timeState.score + "개";
  }

  timeStartBtn.addEventListener("click", function () {
    startTimeAttack();
  });
  timeStartBtn.addEventListener("touchstart", function (e) {
    e.preventDefault();
    startTimeAttack();
  }, { passive: false });

  timeInput.addEventListener("input", updateTimeTyping);
</script>

</body>
</html>
